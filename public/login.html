<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Bejelentkez√©s ‚Ä¢ WhatsApp panel</title>
    <style>
        :root {
            --bg:#ffffff; --text:#111; --accent:#26a69a; --input:#f0f0f0; --border:#ccc;
        }
        @media (prefers-color-scheme: dark) {
            :root { --bg:#1e1e1e; --text:#eee; --accent:#26a69a; --input:#2c2c2c; --border:#444; }
        }
        [data-theme="dark"] { --bg:#1e1e1e; --text:#eee; --input:#2c2c2c; --border:#444; }
        [data-theme="light"]{ --bg:#fff; --text:#111; --input:#f0f0f0; --border:#ccc; }
        *{box-sizing:border-box}
        body{
            margin:0; padding:2rem; min-height:100vh; display:flex; justify-content:center; align-items:center;
            background:var(--bg); color:var(--text); font-family:'Segoe UI', system-ui, -apple-system, Roboto, Ubuntu, Arial, sans-serif;
            transition: background .3s, color .3s;
        }
        .card{
            width:100%; max-width:480px; background:var(--bg); border:1px solid var(--border);
            border-radius:1rem; padding:1.5rem; box-shadow:0 10px 25px rgba(0,0,0,.1);
        }
        h1{margin:0 0 .5rem; font-size:1.4rem; text-align:center}
        .muted{color:#777}
        label{display:block; margin-top:.75rem; margin-bottom:.25rem; font-weight:500}
        input{width:100%; padding:.75rem; border:1px solid var(--border); border-radius:.5rem; background:var(--input); color:var(--text)}
        button{
            width:100%; padding:.75rem; margin-top:1rem; font-size:1rem; background:var(--accent);
            color:#fff; border:none; border-radius:.5rem; cursor:pointer;
        }
        button:hover{ background:#00796b }
        .btn-secondary{ background:transparent; color:var(--text); border:1px solid var(--border); }
        .btn-secondary:hover{ background:color-mix(in oklab, var(--input) 85%, transparent); }
        .btn-linklike{ background:none; color:var(--text); text-decoration:underline; border:none; }
        .row{display:flex; gap:.75rem}
        .row>*{flex:1}
        .tabs{display:flex; gap:.5rem; margin-bottom:1rem}
        .tab{flex:1; padding:.6rem; border:1px solid var(--border); background:var(--input); color:var(--text);
            border-radius:.5rem; cursor:pointer; text-align:center; font-weight:600}
        .tab.active{ outline:2px solid color-mix(in oklab, var(--accent) 35%, transparent); border-color:var(--accent) }
        .theme-toggle{ text-align:right; margin-bottom:.5rem }
        .theme-toggle button{ background:none; border:1px solid var(--border); color:var(--text); border-radius:.5rem; padding:.4rem .6rem; cursor:pointer }
        #msg{min-height:1.2rem; margin-top:.5rem; font-weight:600; text-align:center}
        .hint{font-size:.85rem; color:#777; margin-top:.25rem}
        .error{color:crimson}
        .ok{color:#2e7d32}

        /* Szebb, k√°rty√°s hozz√°j√°rul√°s */
        label.consent{
            display:flex !important; gap:.6rem; align-items:flex-start; padding:.75rem .9rem;
            margin-top:.75rem; background: color-mix(in oklab, var(--input) 85%, transparent);
            border:1px solid var(--border); border-radius:.6rem; cursor:pointer;
            transition: border-color .2s, box-shadow .2s, background .2s;
        }
        label.consent:hover{
            border-color: color-mix(in oklab, var(--accent) 60%, var(--border));
            box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 18%, transparent);
        }
        label.consent input[type="checkbox"]{
            width:1.05rem; height:1.05rem; margin-top:.1rem; accent-color: var(--accent); flex:0 0 auto;
        }
        label.consent span{ font-size:.95rem; line-height:1.35rem; color: var(--text); }
        label.consent a{ color: var(--accent); text-decoration: underline; text-underline-offset: 2px; }
        label.consent.error{
            border-color: crimson !important;
            box-shadow: 0 0 0 3px color-mix(in oklab, crimson 22%, transparent) !important;
        }

        /* MODAL */
        .overlay{
            position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.45); z-index:1000;
            padding:1rem;
        }
        .modal{
            width:100%; max-width:420px; background:var(--bg); color:var(--text); border:1px solid var(--border);
            border-radius:1rem; padding:1rem 1.25rem; box-shadow:0 20px 40px rgba(0,0,0,.25);
            animation:pop .18s ease-out;
        }
        .modal h2{ margin:.25rem 0 .25rem; font-size:1.2rem; text-align:center }
        .modal p{ margin:.25rem 0 .75rem; color:#777; text-align:center }
        .modal .row{ gap:.5rem }
        .modal .actions{
            display:flex;
            gap:.5rem;
            margin-top:.75rem;
            justify-content:space-between;    /* sz√©p eloszt√°s */
            flex-wrap:nowrap;                 /* mindig egy sorban tartjuk */
        }
        .modal .actions button{
            width:auto;                       /* fel√ºl√≠rja a global 100%-ot */
            flex:0 0 auto;
            padding:.6rem 1rem;
            white-space:nowrap;               /* a (11) se t√∂rj√∂n √∫j sorba */
            font-size:.95rem;                 /* pici finom√≠t√°s */
        }
        .modal .actions .btn-secondary{ border:1px solid var(--border); }
        .modal .actions .btn-linklike{
            width:auto;
            padding:.6rem .25rem;
            text-decoration:underline;
        }

        /* Nagyon keskeny k√©perny≈ën engedj√ºk a t√∂r√©st (opcion√°lis) */
        @media (max-width: 360px){
            .modal .actions{ flex-wrap:wrap; }
            .modal .actions button{ flex:1 0 auto; }   /* sz√©pen t√∂rik */
        }
        @keyframes pop{ from{ transform:translateY(8px); opacity:.6 } to{ transform:none; opacity:1 } }
    </style>
</head>
<body>
<div class="card">
    <div class="theme-toggle"><button id="btnTheme" type="button">üåì T√©ma v√°lt√°sa</button></div>
    <h1>Bel√©p√©s a panelre</h1>
    <div class="muted" style="text-align:center; margin-bottom:.75rem;">Jelentkezz be vagy regisztr√°lj √∫j fi√≥kot</div>

    <div class="tabs">
        <div id="tabLogin" class="tab active">Bejelentkez√©s</div>
        <div id="tabReg" class="tab">Regisztr√°ci√≥</div>
    </div>

    <!-- LOGIN -->
    <div id="viewLogin">
        <label>Email / felhaszn√°l√≥n√©v</label>
        <input id="loginId" type="text" placeholder="valaki@pelda.hu vagy pl. kovacs_anna" />
        <label>Jelsz√≥</label>
        <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        <button id="btnLogin">Bel√©p√©s</button>
    </div>

    <!-- REGISTER -->
    <div id="viewReg" style="display:none">
        <!-- (a 'muted' figyelmeztet≈ë sor t√∂r√∂lve) -->

        <label>N√©v</label>
        <input id="regName" type="text" placeholder="pl. Kov√°cs Anna" />

        <label>Felhaszn√°l√≥n√©v (opcion√°lis)</label>
        <input id="regUsername" type="text" placeholder="pl. kovacs_anna" />
        <!-- (a #userHint t√∂r√∂lve) -->

        <label>Email</label>
        <input id="regEmail" type="email" placeholder="valaki@pelda.hu" />

        <label>Jelsz√≥</label>
        <input id="regPass" type="password" placeholder="Er≈ës jelsz√≥" />

        <label>Jelsz√≥ meger≈ës√≠t√©se</label>
        <input id="regPass2" type="password" placeholder="√çrd be √∫jra a jelsz√≥t" />
        <div id="pwHint" class="hint"></div>

        <!-- Owner / WhatsApp be√°ll√≠t√°sok (csak ha needs_owner=true) -->
        <div id="ownerBox" style="display:none; margin-top: .75rem; padding:.75rem; border:1px dashed var(--border); border-radius:.6rem;">
            <div class="muted" style="margin-bottom:.5rem;"><b>Els≈ë ind√≠t√°s:</b> nincs m√©g felhaszn√°l√≥. Hozz l√©tre egy <b>Owner</b> fi√≥kot √©s add meg a WhatsApp/Meta adataidat:</div>
            <label>WABA_ID</label>
            <input id="wabaId" placeholder="pl. 123456789012345" />
            <label>PHONE_NUMBER_ID</label>
            <input id="phoneNumberId" placeholder="pl. 123456789012345" />
            <label>ACCESS_TOKEN</label>
            <input id="accessToken" placeholder="Meta hossz√∫ √©rv√©nyess√©g≈± token" />
            <label>VERIFY_TOKEN</label>
            <input id="verifyToken" placeholder="Webhook verify token" />
        </div>

        <label>Adatkezel√©si t√°j√©koztat√≥</label>
        <label class="consent">
            <input id="acceptPrivacy" type="checkbox" />
            <span>Elfogadom az
          <a href="/privacy.html" target="_blank" rel="noopener">Adatkezel√©si t√°j√©koztat√≥t</a>
        </span>
        </label>
        <div id="privacyHint" class="hint error" style="display:none"></div>

        <button id="btnReg">Regisztr√°ci√≥</button>
    </div>

    <div id="msg" class="muted"></div>
</div>

<!-- MODAL: E-mail ellen≈ërz√©s -->
<div id="codeOverlay" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="codeTitle">
        <h2 id="codeTitle">E-mail ellen≈ërz√©s</h2>
        <p>Elk√ºldt√ºk a 6 sz√°mjegy≈± k√≥dot erre a c√≠mre: <b id="codeEmail"></b></p>
        <label style="text-align:left;">Visszaigazol√≥ k√≥d</label>
        <input id="otpCode" type="text" inputmode="numeric" pattern="[0-9]{6}" maxlength="6" placeholder="6 sz√°mjegy" />
        <div id="otpMsg" class="hint" style="min-height:1.1rem;"></div>
        <div class="actions">
            <button id="btnVerify" type="button">Meger≈ës√≠t√©s</button>
            <button id="btnResend" type="button" class="btn-secondary">K√≥d √∫jrak√ºld√©se</button>
            <button id="btnCancel" type="button" class="btn-linklike">M√©gse</button>
        </div>
    </div>
</div>

<script>
    const $ = s => document.querySelector(s);

    // === T√©ma v√°lt√≥ ===
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) document.body.setAttribute('data-theme', savedTheme);
    $('#btnTheme').onclick = () => {
        const cur = document.body.getAttribute('data-theme');
        const next = cur === 'dark' ? 'light' : 'dark';
        document.body.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
    };

    // === F√ºl v√°lt√°s ===
    const show = (login=true) => {
        $('#tabLogin').classList.toggle('active', login);
        $('#tabReg').classList.toggle('active', !login);
        $('#viewLogin').style.display = login ? 'block' : 'none';
        $('#viewReg').style.display   = login ? 'none'  : 'block';
        $('#msg').textContent = '';
        $('#pwHint').textContent = '';
        $('#pwHint').className = 'hint';
    };
    $('#tabLogin').onclick = () => show(true);
    $('#tabReg').onclick   = () => show(false);

    // === K√∂z√∂s fetch helper ===
    async function api(path, opts={}) {
        const res = await fetch(path, Object.assign({ method:'GET', headers:{'Content-Type':'application/json'} }, opts));
        const isJson = (res.headers.get('content-type')||'').includes('application/json');
        const data = isJson ? await res.json() : await res.text();
        if (!res.ok) throw new Error((data && data.error) || res.statusText);
        return data;
    }

    // === Login ===
    $('#btnLogin').onclick = async () => {
        $('#msg').textContent = 'Bel√©ptet√©s‚Ä¶'; $('#msg').style.color = '';
        try {
            const identifier = $('#loginId').value.trim();
            const password = $('#loginPass').value;
            await api('/admin/auth/login', { method:'POST', body: JSON.stringify({ identifier, password }) });
            $('#msg').textContent = 'Sikeres bejelentkez√©s. √Åtir√°ny√≠t√°s‚Ä¶';
            setTimeout(()=> location.href = '/menu.html', 300);
        } catch (e) {
            $('#msg').textContent = e.message; $('#msg').style.color = 'crimson';
        }
    };

    // === Regisztr√°ci√≥ kliens oldali ellen≈ërz√©sek ===
    function pwStrong(pw){ return pw.length >= 8 && /[a-z]/.test(pw) && /[A-Z]/.test(pw) && /\d/.test(pw); }
    function usernameValid(u){
        if (!u) return true;
        const s = u.trim();
        if (!s) return true;
        const okShape   = /^[a-z0-9](?:[a-z0-9._-]{1,30})[a-z0-9]$/i.test(s);
        const noDoubles = !/(\.\.|__|--)/.test(s);
        return okShape && noDoubles;
    }

    let privacyTouched = false; // <- csak a gombnyom√°s ut√°n mutatjuk a hib√°t

    function validateRegForm(){
        const pw = $('#regPass').value;
        const pw2 = $('#regPass2').value;
        const uname = ($('#regUsername')?.value || '').trim();

        let msg = '';
        if (!pwStrong(pw)) msg = 'Min. 8 karakter, kis-/nagybet≈± √©s sz√°m kell.';
        else if (pw !== pw2) msg = 'A k√©t jelsz√≥ nem egyezik.';

        const okUser = usernameValid(uname);
        const userHintEl = $('#userHint');
        if (userHintEl) userHintEl.className = 'hint' + (okUser ? '' : ' error'); // <- ≈ë m√°r lehet, hogy nincs

        $('#pwHint').textContent = msg;
        $('#pwHint').className = 'hint ' + (msg ? 'error' : 'ok');

        document.querySelector('#btnReg').disabled = !canEnableReg();
    }

    function showPrivacyError(show){
        const label = document.querySelector('label.consent');
        const hint  = $('#privacyHint');
        if (show){
            label.classList.add('error'); hint.style.display = 'block';
            hint.textContent = 'A regisztr√°ci√≥hoz el kell fogadnod az adatkezel√©si t√°j√©koztat√≥t.';
        } else {
            label.classList.remove('error'); hint.style.display = 'none'; hint.textContent = '';
        }
    }

    function canEnableReg(){
        const name  = ($('#regName')?.value || '').trim();
        const email = $('#regEmail').value.trim();
        const p1    = $('#regPass').value;
        const p2    = $('#regPass2').value;
        const uname = ($('#regUsername')?.value || '').trim();

        const okName  = name.length >= 2 && name.length <= 70;
        const okEmail = /^[^@]+@[^@]+\.[^@]+$/.test(email);
        const okPass  = p1.length >= 8 && p1 === p2;
        const okUser  = usernameValid(uname);

        // NEM k√©nyszer√≠tj√ºk r√° a hozz√°j√°rul√°st √©s a k√≥dot a gomb enged√©lyez√©s√©re
        return okName && okEmail && okPass && okUser;
    }

    // √©l≈ë valid√°ci√≥
    ['regPass','regPass2','regUsername','regName','regEmail'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', validateRegForm);
    });
    document.querySelector('#btnReg').disabled = !canEnableReg();

    $('#acceptPrivacy').addEventListener('change', () => {
        if ($('#acceptPrivacy').checked) showPrivacyError(false);
    });

    // === Modal seg√©dek ===
    const modal = {
        open(email){
            $('#codeEmail').textContent = email;
            $('#otpCode').value = '';
            $('#otpMsg').textContent = '';
            $('#codeOverlay').style.display = 'grid';
            $('#codeOverlay').setAttribute('aria-hidden','false');
            setTimeout(()=> $('#otpCode').focus(), 50);
            startResendCooldown(30);
        },
        close(){
            $('#codeOverlay').style.display = 'none';
            $('#codeOverlay').setAttribute('aria-hidden','true');
        }
    };

    let resendTimer = null, remaining = 0;
    function startResendCooldown(sec){
        clearInterval(resendTimer);
        remaining = sec;
        const btn = $('#btnResend');
        btn.disabled = true;
        btn.textContent = `K√≥d √∫jrak√ºld√©se (${remaining})`;
        resendTimer = setInterval(()=>{
            remaining--;
            if (remaining <= 0){
                clearInterval(resendTimer);
                btn.disabled = false;
                btn.textContent = 'K√≥d √∫jrak√ºld√©se';
            } else {
                btn.textContent = `K√≥d √∫jrak√ºld√©se (${remaining})`;
            }
        }, 1000);
    }

    async function sendCode(email){
        const out = await api('/auth/signup/request', { method:'POST', body: JSON.stringify({ email }) });
        return out?.message || 'A k√≥dot elk√ºldt√ºk az emailedre.';
    }

    // === Regisztr√°ci√≥ gomb ===
    $('#btnReg').onclick = async ()=>{
        privacyTouched = true;
        $('#msg').textContent = ''; $('#msg').style.color = '';

        try{
            const display_name = ($('#regName')?.value || '').trim();
            const email = $('#regEmail').value.trim();
            const password = $('#regPass').value;
            const password2 = $('#regPass2').value;
            const username = ($('#regUsername')?.value || '').trim();
            const acceptPrivacy = $('#acceptPrivacy').checked;

            // l√°that√≥ hiba CSAK most
            if (!acceptPrivacy){
                showPrivacyError(true);
                throw new Error('A regisztr√°ci√≥hoz el kell fogadni az adatkezel√©si t√°j√©koztat√≥t.');
            }
            if (!canEnableReg()){
                throw new Error('K√©rlek, t√∂ltsd ki helyesen az √∂sszes mez≈ët.');
            }
            if (password !== password2) throw new Error('A k√©t jelsz√≥ nem egyezik.');

            // 1) k√≥d k√ºld√©s
            $('#msg').textContent = 'K√≥d k√ºld√©se‚Ä¶';
            await sendCode(email);
            $('#msg').textContent = 'K√≥d elk√ºldve. √çrd be a felugr√≥ ablakban.';
            modal.open(email);

            // 2) Modal esem√©nyek
            const doVerify = async ()=>{
                const code = $('#otpCode').value.trim();
                if (!/^\d{6}$/.test(code)){
                    $('#otpMsg').textContent = '6 sz√°mjegy sz√ºks√©ges.'; $('#otpMsg').className = 'hint error';
                    $('#otpCode').focus(); return;
                }
                try{
                    $('#otpMsg').textContent = 'Ellen≈ërz√©s‚Ä¶'; $('#otpMsg').className = 'hint';

                    const common = {
                        email,
                        code,
                        password,
                        acceptPrivacy: true,
                        display_name,
                        username: username || null
                    };

                    if (NEEDS_OWNER) {
                        // extra mez≈ëk
                        const waba_id        = ($('#wabaId')?.value || '').trim();
                        const phone_number_id= ($('#phoneNumberId')?.value || '').trim();
                        const access_token   = ($('#accessToken')?.value || '').trim();
                        const verify_token   = ($('#verifyToken')?.value || '').trim();

                        if (!waba_id || !phone_number_id || !access_token || !verify_token) {
                            $('#otpMsg').textContent = 'T√∂ltsd ki a WhatsApp/Meta mez≈ëket is!'; $('#otpMsg').className = 'hint error';
                            return;
                        }

                        await api('/auth/first-owner/verify', {
                            method:'POST',
                            body: JSON.stringify({ ...common, waba_id, phone_number_id, access_token, verify_token })
                        });
                    } else {
                        // norm√°l verify
                        await api('/auth/signup/verify', {
                            method:'POST',
                            body: JSON.stringify(common)
                        });
                    }

                    $('#otpMsg').textContent = 'Sikeres regisztr√°ci√≥. √Åtir√°ny√≠t√°s‚Ä¶'; $('#otpMsg').className = 'hint ok';
                    setTimeout(()=> location.href = '/menu.html', 300);
                }catch(e){
                    $('#otpMsg').textContent = e.message || 'Hiba t√∂rt√©nt.'; $('#otpMsg').className = 'hint error';
                    $('#otpCode').focus();
                }
            };

            $('#btnVerify').onclick = doVerify;
            $('#otpCode').onkeydown = (ev)=>{ if (ev.key === 'Enter') doVerify(); };
            $('#btnResend').onclick = async ()=>{
                try{
                    $('#otpMsg').textContent = '√öjrak√ºld√©s‚Ä¶'; $('#otpMsg').className = 'hint';
                    await sendCode(email);
                    $('#otpMsg').textContent = 'K√≥d √∫jrak√ºldve.'; $('#otpMsg').className = 'hint ok';
                    startResendCooldown(30);
                }catch(e){
                    $('#otpMsg').textContent = e.message || '√öjrak√ºld√©si hiba.'; $('#otpMsg').className = 'hint error';
                }
            };
            $('#btnCancel').onclick = ()=> modal.close();

        }catch(e){
            $('#msg').textContent = e.message;
            $('#msg').style.color = 'crimson';
        }
    };

    // ESC z√°rja a modalt
    document.addEventListener('keydown', (e)=>{
        if (e.key === 'Escape' && $('#codeOverlay').style.display === 'grid') modal.close();
    });

    let NEEDS_OWNER = false;
    // Indul√°skor n√©zz√ºk meg, kell-e owner flow
    (async function initSetupState(){
        try{
            const st = await api('/admin/setup/state');
            NEEDS_OWNER = !!st?.needs_owner;
            if (NEEDS_OWNER) {
                document.querySelector('#ownerBox').style.display = 'block';
                document.querySelector('#tabReg').textContent = 'Owner regisztr√°ci√≥';
            }
        }catch(e){
            // ha valami√©rt nem √©rj√ºk el, marad a default (norm√°l reg)
            console.warn('setup/state hiba:', e.message);
        }
    })();
</script>
</body>
</html>