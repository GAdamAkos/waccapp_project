<!doctype html>
<html lang="hu">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Admin ‚Äì Bejelentkez√©s, Jogosults√°gok, Hozz√°j√°rul√°sok</title>
    <style>
        :root{
            --bg:#ffffff;--text:#111;--accent:#26a69a;--input:#f0f0f0;--border:#ccc;
            --muted:#666;--danger:#c62828;--warn:#f57f17;--ok:#2e7d32;--shadow:0 10px 25px rgba(0,0,0,.08);
        }
        @media (prefers-color-scheme: dark){
            :root{
                --bg:#1e1e1e;--text:#eee;--accent:#26a69a;--input:#2c2c2c;--border:#444;
                --muted:#a4a4a4;--danger:#ef5350;--warn:#fbc02d;--ok:#66bb6a;--shadow:0 12px 30px rgba(0,0,0,.35);
            }
        }
        [data-theme="dark"]{--bg:#1e1e1e;--text:#eee;--input:#2c2c2c;--border:#444;--muted:#a4a4a4;--shadow:0 12px 30px rgba(0,0,0,.35)}
        [data-theme="light"]{--bg:#ffffff;--text:#111;--input:#f0f0f0;--border:#ccc;--muted:#666;--shadow:0 10px 25px rgba(0,0,0,.08)}
        *{box-sizing:border-box}
        body{
            margin:0;padding:2rem;min-height:100vh;display:flex;justify-content:center;align-items:flex-start;
            background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,-apple-system,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;
            transition:background .3s,color .3s;
        }
        .container{width:100%;max-width:1100px}
        .header-bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem}
        h1{margin:0;font-size:1.6rem;color:var(--text)}
        .theme-toggle button{background:none;border:1px solid var(--border);color:var(--text);border-radius:.6rem;padding:.5rem .75rem;cursor:pointer}
        .shell{display:grid;grid-template-columns:260px 1fr;gap:1rem}
        @media (max-width:900px){.shell{grid-template-columns:1fr}}
        .card{background:var(--bg);border:1px solid var(--border);border-radius:1rem;box-shadow:var(--shadow);padding:1rem}
        nav{display:grid;gap:.5rem}
        nav button{width:100%;padding:.7rem .9rem;border-radius:.6rem;border:1px solid var(--border);background:var(--input);color:var(--text);cursor:pointer}
        nav button.active{border-color:var(--accent);outline:2px solid color-mix(in oklab, var(--accent) 30%, transparent);background:color-mix(in oklab, var(--input) 80%, var(--accent))}
        .badge{display:inline-block;padding:.35rem .6rem;border-radius:999px;border:1px solid var(--border);background:var(--input);color:var(--muted);font-size:.85rem}
        .badge.ok{color:var(--ok);border-color:color-mix(in oklab, var(--ok) 50%, var(--border))}
        .badge.warn{color:var(--warn)}
        .tag{display:inline-block;padding:.2rem .6rem;border-radius:999px;border:1px solid var(--border);background:var(--input);font-size:.8rem;color:var(--text)}
        label{display:block;margin-top:.75rem;margin-bottom:.25rem;font-weight:500;color:var(--text)}
        input,select,button,textarea{width:100%;padding:.7rem .9rem;border:1px solid var(--border);border-radius:.6rem;background:var(--input);color:var(--text);font-size:1rem}
        textarea{min-height:110px}
        button.primary{background:var(--accent);color:#fff;border:none}
        button.primary:hover{background:#00796b}
        button.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
        button.danger{background:var(--danger);color:#fff;border:none}
        .row{display:flex;gap:.75rem}.row>*{flex:1}.row+.row{margin-top:.5rem}
        .muted{color:var(--muted)}.sep{height:1px;background:var(--border);margin:1rem 0}
        table{width:100%;border-collapse:collapse}th,td{border-bottom:1px solid var(--border);text-align:left;padding:.6rem .4rem}th{font-weight:600;color:var(--text)}
        .hidden{display:none}.toolbar{display:flex;gap:.5rem;align-items:center;justify-content:space-between}
    </style>
</head>
<body>
<div class="container" id="app">
    <div class="header-bar">
        <h1>Admin fel√ºlet</h1>
        <div style="display:flex;gap:.5rem;align-items:center;">
            <div id="accountBadge" class="badge">Nincs bejelentkezve</div>
            <div class="theme-toggle"><button type="button" id="btnTheme">üåì T√©ma v√°lt√°sa</button></div>
        </div>
    </div>

    <div class="shell">
        <!-- BAL: Navig√°ci√≥ -->
        <aside class="card">
            <nav>
                <button id="navSetup">Els≈ë owner l√©trehoz√°sa</button>
                <button id="navUsers" class="active">Felhaszn√°l√≥k & szerepek</button>
                <button id="navConsents">Hozz√°j√°rul√°sok</button>
                <button id="navConfig">WhatsApp / Meta be√°ll√≠t√°sok</button>
                <button id="navAccount">Saj√°t fi√≥k</button>

                <!-- √öJ: Vissza a men√ºbe -->
                <button id="navBack">‚Üê Vissza a men√ºbe</button>

                <button id="navLogout" class="danger">Kijelentkez√©s</button>
            </nav>
            <div class="sep"></div>
            <div class="muted" style="font-size:.9rem;">
                <p>Tippek:</p>
                <ul style="margin:.2rem 0 .4rem 1rem;padding:0;">
                    <li>Az <span class="tag">Els≈ë owner</span> csak egyszer sz√ºks√©ges (<code>ADMIN_SETUP_TOKEN</code>).</li>
                    <li>Bejelentkez√©s ut√°n l√°that√≥ a jogosults√°g- √©s hozz√°j√°rul√°s-kezel√©s.</li>
                </ul>
            </div>
        </aside>

        <!-- JOBB: N√©zetek -->
        <main class="card">
            <!-- LOGIN N√âZET ELT√ÅVOL√çTVA -->

            <!-- SETUP OWNER -->
            <section id="viewSetup" class="hidden">
                <h2 style="margin:.2rem 0;">Els≈ë owner l√©trehoz√°sa</h2>

                <div class="row">
                    <div><label>Setup token (<code>ADMIN_SETUP_TOKEN</code>)</label><input id="setupToken" placeholder="EGYSZERI_OWNER_SETUP_TOKEN"/></div>
                </div>

                <div class="row">
                    <div><label>Owner email</label><input id="setupEmail" type="email" placeholder="owner@pelda.hu"/></div>
                    <div><label>Owner jelsz√≥</label><input id="setupPass" type="password" placeholder="Er≈ës jelsz√≥"/></div>
                </div>

                <!-- √öJ: Owner n√©v -->
                <div class="row">
                    <div><label>Owner n√©v</label><input id="setupName" placeholder="pl. Kov√°cs Anna"/></div>
                </div>

                <div class="row" style="margin-top:.75rem;"><button id="btnSetup" class="primary">Owner l√©trehoz√°sa</button></div>
                <div id="setupMsg" class="muted" style="margin-top:.5rem;min-height:1.2rem;"></div>
            </section>

            <!-- USERS & ROLES -->
            <section id="viewUsers">
                <div class="toolbar">
                    <h2 style="margin:.2rem 0;">Felhaszn√°l√≥k & szerepek</h2>
                    <span id="roleBadge" class="badge">‚Äî</span>
                </div>

                <h3 class="muted">Felhaszn√°l√≥k list√°ja</h3>
                <div class="row" style="margin:.5rem 0 0 0;">
                    <div><input id="userSearch" placeholder="Keres√©s n√©v/email/szerep‚Ä¶"></div>
                    <div style="flex:0 0 auto;align-self:end;">
                        <button id="btnExportUsers" class="ghost">Export CSV</button>
                    </div>
                </div>
                <table>
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>N√©v</th>
                        <th>Email</th>
                        <th>Szerep</th>
                        <th>Utolj√°ra bel√©pve</th>
                        <th>M≈±velet</th>
                    </tr>
                    </thead>
                    <tbody id="usersTbody">
                    <tr><td colspan="6" class="muted">Nincs adat‚Ä¶</td></tr>
                    </tbody>
                </table>
                <div id="usersMsg" class="muted" style="margin-top:.5rem;min-height:1.2rem;"></div>
            </section>

            <!-- CONSENTS -->
            <section id="viewConsents" class="hidden">
                <h2 style="margin:.2rem 0;">Hozz√°j√°rul√°sok</h2>
                <div class="row">
                    <div><label>wa_id</label><input id="qWa" placeholder="36123456789"/></div>
                    <div>
                        <label>scope</label>
                        <select id="qScope">
                            <option value="">(mind)</option><option>marketing</option><option>utility</option><option>auth</option>
                        </select>
                    </div>
                    <div style="align-self:end;"><button id="btnLoadConsents" class="ghost">Bet√∂lt√©s</button></div>
                </div>

                <div class="sep"></div>

                <h3 class="muted">√öj hozz√°j√°rul√°s</h3>
                <div class="row">
                    <div><label>wa_id</label><input id="cWa" placeholder="36123456789"/></div>
                    <div><label>phone (opcion√°lis)</label><input id="cPhone" placeholder="+36301234567"/></div>
                    <div>
                        <label>scope</label>
                        <select id="cScope"><option>marketing</option><option>utility</option><option>auth</option></select>
                    </div>
                </div>
                <div class="row">
                    <div><label>source</label><input id="cSource" placeholder="webform / qr / bolt / import"/></div>
                    <div><label>proof (URL vagy le√≠r√°s)</label><input id="cProof" placeholder="https://‚Ä¶ / jegyzet"/></div>
                </div>
                <div class="row" style="margin-top:.75rem;"><button id="btnCreateConsent" class="primary">Hozz√°j√°rul√°s ment√©se</button></div>

                <div class="sep"></div>

                <h3 class="muted">Tal√°latok</h3>
                <table>
                    <thead><tr><th>ID</th><th>wa_id</th><th>scope</th><th>source</th><th>granted_at</th><th>revoked_at</th><th></th></tr></thead>
                    <tbody id="consentsTbody"><tr><td colspan="7" class="muted">Nincs adat‚Ä¶</td></tr></tbody>
                </table>
                <div id="consentsMsg" class="muted" style="margin-top:.5rem;min-height:1.2rem;"></div>
            </section>

            <!-- CONFIG (csak ownernek l√°tszik majd) -->
            <section id="viewConfig" class="hidden">
                <h2 style="margin:.2rem 0;">WhatsApp / Meta be√°ll√≠t√°sok</h2>
                <div class="muted" style="margin-bottom:.5rem;">
                    Csak az <b>Owner</b> m√≥dos√≠thatja. A ment√©s a <code>.env</code>-be √≠r.
                    <br><i>‚òÖ</i> = √©rz√©keny mez≈ë (√©rt√©ke elrejtve), <span class="badge warn">‚ö†Ô∏è √∫jraind√≠t√°s</span> = m√≥dos√≠t√°s ut√°n szerver √∫jraind√≠t√°sa aj√°nlott.
                </div>

                <div id="envForm"></div>

                <div class="row" style="margin-top:.75rem;">
                    <div style="flex:0 0 auto;"><button id="btnEnvLoad" class="ghost">Beolvas√°s</button></div>
                    <div><button id="btnEnvSave" class="primary">Ment√©s</button></div>
                </div>
                <div id="envMsg" class="muted" style="margin-top:.5rem;min-height:1.2rem;"></div>
            </section>

            <!-- ACCOUNT -->
            <section id="viewAccount" class="hidden">
                <h2 style="margin:.2rem 0;">Saj√°t fi√≥k</h2>

                <h3 class="muted">Profil</h3>
                <div class="row">
                    <div>
                        <label>Email (bejelentkez√©shez)</label>
                        <input id="accEmail" readonly />
                    </div>
                    <div>
                        <label>Szerep</label>
                        <input id="accRole" readonly />
                    </div>
                </div>
                <div class="row">
                    <div>
                        <label>N√©v (k√∂telez≈ë)</label>
                        <input id="accDisplayName" placeholder="pl. Kov√°cs Anna" />
                        <div id="nameCooldown" class="muted" style="margin-top:.25rem;"></div>
                    </div>
                    <div>
                        <label>Felhaszn√°l√≥n√©v (opcion√°lis)</label>
                        <input id="accUsername" placeholder="pl. kovacs_anna" />
                    </div>
                    <div style="align-self:end;">
                        <button id="btnSaveProfile" class="primary">Profil ment√©se</button>
                    </div>
                </div>
                <div id="accMsg" class="muted" style="margin-top:.5rem;min-height:1.2rem;"></div>

                <div class="sep"></div>

                <h3 class="muted">Jelsz√≥ m√≥dos√≠t√°s</h3>
                <div class="row">
                    <div><label>Jelenlegi jelsz√≥</label><input id="pwCur" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
                    <div><label>√öj jelsz√≥</label><input id="pwNew" type="password" placeholder="Min. 8 karakter, kis- √©s nagybet≈±, sz√°m"/></div>
                    <div><label>√öj jelsz√≥ m√©gegyszer</label><input id="pwNew2" type="password" placeholder="Egyezzen meg az el≈ëz≈ëvel"/></div>
                </div>
                <div class="row" style="margin-top:.75rem;">
                    <button id="btnChangePw" class="primary">Jelsz√≥ friss√≠t√©se</button>
                </div>
                <div id="pwMsg" class="muted" style="margin-top:.5rem;min-height:1.2rem;"></div>

                <div class="sep"></div>

                <h3 class="muted">E-mail csere (opcion√°lis)</h3>
                <div class="row">
                    <div><label>√öj e-mail</label><input id="emNew" type="email" placeholder="uj@pelda.hu"/></div>
                    <div><label>Jelsz√≥ meger≈ës√≠t√©s</label><input id="emPw" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
                    <div style="align-self:end;"><button id="btnChangeEmail" class="ghost">E-mail m√≥dos√≠t√°sa</button></div>
                </div>
                <div id="emMsg" class="muted" style="margin-top:.5rem;min-height:1.2rem;"></div>

                <div class="sep"></div>

                <h3 class="muted">Fi√≥k inform√°ci√≥k</h3>
                <div class="row">
                    <div><label>L√©trehozva</label><input id="accCreated" readonly/></div>
                    <div><label>Utolj√°ra bel√©pve</label><input id="accLastLogin" readonly/></div>
                </div>
                <div class="row">
                    <div><label>Adatkezel√©s elfogadva</label><input id="privAcceptedAt" readonly/></div>
                    <div><label>Verzi√≥</label><input id="privVersion" readonly/></div>
                    <div><label>IP</label><input id="privIp" readonly/></div>
                </div>

                <!-- Vesz√©lyes m≈±velet -->
                <div class="sep"></div>
                <h3 class="muted">Vesz√©lyes m≈±velet</h3>
                <div id="selfDeleteWrap" class="row">
                    <div>
                        <p id="selfDeleteNote" class="muted" style="margin:.25rem 0 .5rem 0;">
                            A fi√≥k t√∂rl√©se v√©gleges.
                        </p>
                        <button id="btnDeleteSelf" class="danger">Fi√≥kom t√∂rl√©se</button>
                    </div>
                </div>
                <div id="delMsg" class="muted" style="margin-top:.5rem;min-height:1.2rem;"></div>
            </section>
        </main>
    </div>
</div>

<script>
    // --- Theme toggle
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) document.body.setAttribute('data-theme', savedTheme);
    document.getElementById('btnTheme').onclick = () => {
        const cur = document.body.getAttribute('data-theme');
        const next = cur === 'dark' ? 'light' : 'dark';
        document.body.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
    };

    // --- Mini helper
    const $ = s => document.querySelector(s);

    function show(id){
        const sections = ['viewSetup','viewUsers','viewConsents','viewAccount','viewConfig'];
        sections.forEach(sec => {
            const el = document.getElementById(sec);
            if (el) el.classList.toggle('hidden', sec !== id);
        });
        const activeMap = {
            viewSetup:'navSetup', viewUsers:'navUsers', viewConsents:'navConsents',
            viewAccount:'navAccount', viewConfig:'navConfig'
        };
        ['navSetup','navUsers','navConsents','navAccount','navConfig'].forEach(btnId => {
            const el = document.getElementById(btnId);
            if (el) el.classList.toggle('active', btnId === activeMap[id]);
        });
    }

    // Nav esem√©nyek
    $('#navSetup').onclick    = () => show('viewSetup');
    $('#navUsers').onclick    = () => { show('viewUsers'); loadUsers(); };
    $('#navConsents').onclick = () => { show('viewConsents'); loadConsents(); };
    $('#navAccount').onclick  = () => { show('viewAccount'); loadAccount(); };
    $('#navConfig').onclick   = () => { show('viewConfig'); $('#btnCfgLoad')?.click(); };

    // indul√°skor pl.:
    show('viewUsers');

    async function api(path, opts={}) {
        const res = await fetch(path, Object.assign({
            method:'GET', headers:{'Content-Type':'application/json'}
        }, opts));
        const isJson = (res.headers.get('content-type')||'').includes('application/json');
        const data = isJson ? await res.json() : await res.text();
        if (!res.ok) throw new Error((data && data.error) || res.statusText);
        return data;
    }

    function setBadge(me){
        const badge = document.getElementById('accountBadge');
        const roleBadge = document.getElementById('roleBadge');
        if (me){
            badge.textContent = me.email + ' ¬∑ ' + me.role;
            badge.classList.add('ok'); badge.classList.remove('warn');
            if (roleBadge) roleBadge.textContent = 'Szereped: ' + me.role;
            const meBox = document.getElementById('meBox');
            if (meBox) meBox.textContent = `${me.email} ¬∑ ${me.role}`;
        } else {
            badge.textContent = 'Nincs bejelentkezve';
            badge.classList.remove('ok'); badge.classList.add('warn');
            if (roleBadge) roleBadge.textContent = '‚Äî';
        }
    }

    // --- Navig√°ci√≥ (nincs navLogin)
    document.getElementById('navSetup').onclick    = ()=> show('viewSetup');
    document.getElementById('navUsers').onclick    = ()=> { show('viewUsers'); loadUsers(); };
    document.getElementById('navConsents').onclick = ()=> { show('viewConsents'); loadConsents(); };
    document.getElementById('navAccount').onclick  = ()=> { show('viewAccount'); loadAccount(); };
    document.getElementById('navBack').onclick     = ()=> { location.href = 'menu.html'; };
    document.getElementById('navLogout').onclick   = logout;

    // --- Kijelentkez√©s (navbar + Account n√©zet)
    async function logout(){
        try { await api('/admin/auth/logout', {method:'POST'}); }
        catch(e){}
        location.href = '/login.html';
    }

    // --- Setup owner
    document.getElementById('btnSetup').onclick = async () => {
        const token = $('#setupToken').value.trim();
        const email = $('#setupEmail').value.trim();
        const password = $('#setupPass').value;
        const display_name = $('#setupName').value.trim();        // ‚¨ÖÔ∏è √öJ
        $('#setupMsg').textContent = 'L√©trehoz√°s‚Ä¶';
        try{
            const res = await fetch('/admin/setup/owner', {
                method:'POST',
                headers:{'Content-Type':'application/json','x-setup-token':token},
                body: JSON.stringify({ email, password, display_name }) // ‚¨ÖÔ∏è √öJ
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || 'Hiba');
            $('#setupMsg').textContent = `Owner l√©trehozva (id ${data.user_id}).`;
            show('viewUsers');
        }catch(e){ $('#setupMsg').textContent = e.message; }
    };

    // --- Users
    let __usersCache = [];

    function renderUsers(rows){
        const tb = document.getElementById('usersTbody');
        if (!rows.length){
            tb.innerHTML = '<tr><td colspan="6" class="muted">Nincs tal√°lat</td></tr>';
            return;
        }
        tb.innerHTML = rows.map(u => `
        <tr>
          <td>${u.id}</td>
          <td>
              <div>${u.display_name || '‚Äî'}</div>
              <div class="muted" style="font-size:.85rem;">${u.username ? '@'+u.username : '‚Äî'}</div>
            </td>
          <td>${u.email}</td>
          <td>
            <select data-id="${u.id}">
              <option${u.role==='viewer'?' selected':''}>viewer</option>
              <option${u.role==='analyst'?' selected':''}>analyst</option>
              <option${u.role==='operator'?' selected':''}>operator</option>
              <option${u.role==='admin'?' selected':''}>admin</option>
              <option${u.role==='owner'?' selected':''} disabled>owner</option>
            </select>
          </td>
          <td>${u.last_login||'‚Äî'}</td>
          <td>
            <button class="ghost small" data-act="save" data-id="${u.id}">Ment√©s</button>
            ${(window.__me && window.__me.role==='owner' && u.role!=='owner')
            ? `<button class="danger small" data-act="del" data-id="${u.id}" data-email="${u.email}">T√∂rl√©s</button>` : ''}
          </td>
        </tr>`).join('');
    }

    function filterUsers(q){
        q = (q||'').trim().toLowerCase();
        if (!q) return __usersCache;
        return __usersCache.filter(u =>
            String(u.id).includes(q) ||
            (u.display_name||'').toLowerCase().includes(q) ||
            (u.username||'').toLowerCase().includes(q) ||   // ‚ÄºÔ∏è √öJ
            (u.email||'').toLowerCase().includes(q) ||
            (u.role||'').toLowerCase().includes(q)
        );
    }

    function usersToCsv(rows){
        const head = ['id','display_name','username','email','role','created_at','last_login']; // ‚ÄºÔ∏è √öJ oszlop
        const esc = s => `"${String(s??'').replace(/"/g,'""')}"`;
        const body = rows.map(r => head.map(k => esc(r[k])).join(',')).join('\n');
        return head.join(',') + '\n' + body;
    }

    async function loadUsers(){
        try{
            const data = await api('/admin/users');
            // cache + els≈ë render
            __usersCache = data.items || [];
            renderUsers(__usersCache);

            // ---- esem√©nykezel≈ëk: csak egyszer k√∂tj√ºk be ----
            const tb = document.getElementById('usersTbody');
            if (tb && !tb.__wired){
                tb.__wired = true;
                tb.addEventListener('click', async (ev) => {
                    // t√∂rl√©s
                    const delBtn = ev.target.closest('button[data-act="del"]');
                    if (delBtn) {
                        const id = delBtn.getAttribute('data-id');
                        const email = delBtn.getAttribute('data-email');
                        if (!confirm(`T√∂rl√∂d ezt a felhaszn√°l√≥t?\n${email} (id=${id})`)) return;
                        try{
                            await api(`/admin/users/${id}`, { method:'DELETE', body: JSON.stringify({ reason: 'admin-ui' }) });
                            $('#usersMsg').textContent = 'Felhaszn√°l√≥ t√∂r√∂lve';
                            await loadUsers();
                        }catch(e){
                            $('#usersMsg').textContent = e.message;
                        }
                        return;
                    }
                    // szerep ment√©se
                    const btn = ev.target.closest('button[data-act="save"]');
                    if (!btn) return;
                    const id = btn.getAttribute('data-id');
                    const sel = tb.querySelector(`select[data-id="${id}"]`);
                    const role = sel?.value;
                    try{
                        await api(`/admin/users/${id}`, { method:'PATCH', body: JSON.stringify({ role }) });
                        $('#usersMsg').textContent = 'Szerep friss√≠tve';
                        await loadUsers();
                    }catch(e){
                        $('#usersMsg').textContent = e.message;
                    }
                });
            }

            // keres≈ë bek√∂t√©se
            const inp = document.getElementById('userSearch');
            if (inp && !inp.__wired){
                inp.__wired = true;
                let t;
                inp.addEventListener('input', () => {
                    clearTimeout(t);
                    t = setTimeout(() => renderUsers(filterUsers(inp.value)), 120);
                });
            }

            // CSV export
            const btn = document.getElementById('btnExportUsers');
            if (btn && !btn.__wired){
                btn.__wired = true;
                btn.addEventListener('click', () => {
                    const q = document.getElementById('userSearch')?.value || '';
                    const rows = filterUsers(q);
                    const csv = usersToCsv(rows);
                    const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `users_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
                    a.click();
                });
            }
        }catch(e){
            document.getElementById('usersTbody').innerHTML =
                `<tr><td colspan="6" class="muted">${e.message}</td></tr>`;
        }
    }

    // --- Consents
    document.getElementById('btnLoadConsents').onclick = loadConsents;
    async function loadConsents(){
        const wa = $('#qWa').value.trim();
        const scope = $('#qScope').value || '';
        const qs = new URLSearchParams(); if (wa) qs.set('wa_id', wa); if (scope) qs.set('scope', scope);
        try{
            const data = await api('/admin/consents' + (qs.toString()?`?${qs}`:''));
            const tb = document.getElementById('consentsTbody');
            if (!data.items || !data.items.length){
                tb.innerHTML = '<tr><td colspan="7" class="muted">Nincs tal√°lat</td></tr>';
                return;
            }
            tb.innerHTML = '';
            for (const c of data.items){
                const tr = document.createElement('tr');
                tr.innerHTML = `
          <td>${c.id}</td>
          <td>${c.wa_id}</td>
          <td><span class="tag">${c.scope}</span></td>
          <td>${c.source||'‚Äî'}</td>
          <td>${c.granted_at}</td>
          <td>${c.revoked_at||'‚Äî'}</td>
          <td>${c.revoked_at ? '' : `<button class="danger small" data-revoke="${c.id}">Visszavon√°s</button>`}</td>`;
                tb.appendChild(tr);
            }
            tb.onclick = async (ev) => {
                const btn = ev.target.closest('button[data-revoke]'); if (!btn) return;
                const id = btn.getAttribute('data-revoke');
                try{ await api(`/admin/consents/${id}/revoke`, {method:'POST'}); loadConsents(); }
                catch(e){ document.getElementById('consentsMsg').textContent = e.message; }
            };
        }catch(e){
            document.getElementById('consentsTbody').innerHTML = `<tr><td colspan="7" class="muted">${e.message}</td></tr>`;
        }
    }

    // --- Saj√°t fi√≥k bet√∂lt√©se √©s m≈±veletek
    async function loadAccount(){
        try{
            const data = await api('/admin/account');
            const m = data.me || {};

            $('#accEmail').value = m.email || '';
            $('#accRole').value  = m.role || '';
            $('#accDisplayName').value = m.display_name || '';
            $('#accUsername').value    = m.username || '';

            const nameInput = $('#accDisplayName');
            const nameCooldownNote = $('#nameCooldown');   // <-- √°tnevezve
            if (m.name_change_locked) {
                nameInput.disabled = true;
                nameCooldownNote.textContent = `A n√©v 30 naponta m√≥dos√≠that√≥. K√∂vetkez≈ë leghamarabb: ${m.name_locked_until}`;
            } else {
                nameInput.disabled = false;
                nameCooldownNote.textContent = '';
            }

            $('#accCreated').value = m.created_at || '';
            $('#accLastLogin').value = m.last_login || '';
            $('#privAcceptedAt').value = m.privacy_accepted_at || '‚Äî';
            $('#privVersion').value    = m.privacy_version || '‚Äî';
            $('#privIp').value         = m.privacy_accepted_ip || '‚Äî';

            const namePart = m.display_name ? (m.display_name + ' ¬∑ ') : '';
            const meTxt = `${namePart}${m.email} ¬∑ ${m.role}`;
            const meBox = $('#meBox');
            if (meBox) meBox.textContent = meTxt;

            const selfWrap = document.getElementById('selfDeleteWrap');
            if (selfWrap) selfWrap.style.display = '';

            const deleteNote = document.getElementById('selfDeleteNote'); // <-- √°tnevezve
            if (deleteNote) {
                deleteNote.textContent = (m.role === 'owner')
                    ? 'Ownerk√©nt a t√∂rl√©s csak akkor enged√©lyezett, ha marad m√°sik owner.'
                    : 'A fi√≥k t√∂rl√©se v√©gleges.';
            }

            const btnSelf = document.getElementById('btnDeleteSelf');
            if (btnSelf) btnSelf.onclick = async () => {
                const confirmMsg = (m.role === 'owner')
                    ? 'Owner vagy. A t√∂rl√©s csak akkor enged√©lyezett, ha marad m√°sik owner. Folytatod?'
                    : 'Biztosan t√∂rl√∂d a fi√≥kodat? Ez v√©gleges m≈±velet.';
                if (!confirm(confirmMsg)) return;

                try{
                    await api('/admin/account/delete', { method:'POST' }); // <-- el√©g, ha lefut hiba n√©lk√ºl
                    location.href = '/login.html';
                }catch(e){
                    document.getElementById('delMsg').textContent = e.message || 'Hiba a t√∂rl√©skor.';
                }
            };
        }catch(e){
            $('#accMsg').textContent = e.message || 'Hiba a fi√≥k bet√∂lt√©sekor';
        }
    }

    // Profil ment√©se (display_name)
    document.getElementById('btnSaveProfile').onclick = async () => {
        const display_name = $('#accDisplayName').value.trim();
        const username     = $('#accUsername').value.trim();
        $('#accMsg').textContent = 'Ment√©s‚Ä¶';
        try{
            const res = await api('/admin/account', {
                method:'PATCH',
                body: JSON.stringify({ display_name, username: username || null })
            });
            $('#accMsg').textContent = 'Profil friss√≠tve.';
            loadAccount();
        }catch(e){
            $('#accMsg').textContent = e.message;
        }
    };

    // Jelsz√≥ m√≥dos√≠t√°s
    document.getElementById('btnChangePw').onclick = async () => {
        const current_password = $('#pwCur').value;
        const new_password = $('#pwNew').value;
        const new_password2 = $('#pwNew2').value;
        if (new_password !== new_password2) {
            $('#pwMsg').textContent = 'Az √∫j jelszavak nem egyeznek.';
            return;
        }
        $('#pwMsg').textContent = 'Friss√≠t√©s‚Ä¶';
        try{
            await api('/admin/account/change-password', {
                method:'POST',
                body: JSON.stringify({ current_password, new_password })
            });
            $('#pwMsg').textContent = 'Jelsz√≥ friss√≠tve.';
            $('#pwCur').value=''; $('#pwNew').value=''; $('#pwNew2').value='';
        }catch(e){
            $('#pwMsg').textContent = e.message;
        }
    };

    // Email csere
    document.getElementById('btnChangeEmail').onclick = async () => {
        const new_email = $('#emNew').value.trim();
        const password  = $('#emPw').value;
        if (!new_email || !password){
            $('#emMsg').textContent = 'Add meg az √∫j e-mailt √©s a jelsz√≥t.';
            return;
        }
        $('#emMsg').textContent = 'M√≥dos√≠t√°s‚Ä¶';
        try{
            const res = await api('/admin/account/change-email', {
                method:'POST',
                body: JSON.stringify({ new_email, password })
            });
            $('#emMsg').textContent = 'E-mail friss√≠tve.';
            // badge friss√≠t√©s
            if (res.me) setBadge(res.me);
            // √∫j email megjelen√≠t√©se
            $('#accEmail').value = res.me?.email || new_email;
            $('#emNew').value=''; $('#emPw').value='';
        }catch(e){
            $('#emMsg').textContent = e.message;
        }
    };

    // --- Indul√°skor: me() ‚Äî ha nincs auth, azonnal login.html
    (async () => {
        try{
            const data = await api('/admin/me');
            window.__me = data.me;
            setBadge(data.me);
            if (!window.__me || window.__me.role !== 'owner') {
                const btnCfg = document.getElementById('navConfig');
                if (btnCfg) btnCfg.style.display = 'none';       // tab a men√ºb≈ël elt≈±nik
                // ha valaki direkt URL-lel pr√≥b√°l oda menni, az API √∫gyis 403-at ad
            } else {
                // owner eset√©n a tab kattint√°sra t√∂lts√ºk be az √©rt√©keket
                document.getElementById('navConfig').onclick = () => { show('viewConfig'); loadEnvAll(); };
            }
            show('viewUsers');
            loadUsers();
        }catch{
            location.href = '/login.html';
        }
    })();

    // Nav kapcsol√≥k
    const $nav = s => document.querySelector(s);
    const $v   = s => document.querySelector(s);
    $nav('#navConfig')?.addEventListener('click', ()=>{
        ['#viewUsers','#viewConsents','#viewAccount','#viewSetup'].forEach(id => $v(id)?.classList.add('hidden'));
        $v('#viewConfig')?.classList.remove('hidden');
        // bet√∂lt√©s automatikusan
        document.getElementById('btnCfgLoad')?.click();
    });

    async function apiJson(path, opts={}) {
        const res = await fetch(path, Object.assign({ headers:{'Content-Type':'application/json'} }, opts));
        const isJson = (res.headers.get('content-type')||'').includes('application/json');
        const data = isJson ? await res.json() : await res.text();
        if (!res.ok) throw new Error((data && data.error) || res.statusText);
        return data;
    }

    document.getElementById('btnCfgLoad')?.addEventListener('click', async ()=>{
        const msg = document.getElementById('cfgMsg');
        msg.textContent = 'Bet√∂lt√©s‚Ä¶';
        try{
            const { config } = await apiJson('/admin/config/whatsapp');
            document.getElementById('cfgWabaId').value   = config?.WHATSAPP_BUSINESS_ACCOUNT_ID || '';
            document.getElementById('cfgPhoneId').value  = config?.PHONE_NUMBER_ID || '';
            document.getElementById('cfgAccessToken').placeholder = config?.ACCESS_TOKEN_MASKED || '';
            document.getElementById('cfgVerifyToken').placeholder = config?.VERIFY_TOKEN_MASKED || '';
            msg.textContent = 'K√©sz.';
        }catch(e){
            msg.textContent = e.message; msg.style.color = 'crimson';
        }
    });

    document.getElementById('btnCfgSave')?.addEventListener('click', async ()=>{
        const msg = document.getElementById('cfgMsg'); msg.style.color = '';
        msg.textContent = 'Ment√©s‚Ä¶';
        try{
            const body = {
                WHATSAPP_BUSINESS_ACCOUNT_ID: document.getElementById('cfgWabaId').value.trim(),
                PHONE_NUMBER_ID: document.getElementById('cfgPhoneId').value.trim()
            };
            const acc = document.getElementById('cfgAccessToken').value.trim();
            const ver = document.getElementById('cfgVerifyToken').value.trim();
            if (acc) body.ACCESS_TOKEN = acc;
            if (ver) body.VERIFY_TOKEN = ver;

            await apiJson('/admin/config/whatsapp', { method:'PUT', body: JSON.stringify(body) });
            msg.textContent = 'Be√°ll√≠t√°sok friss√≠tve (.env is)!';
        }catch(e){
            msg.textContent = e.message; msg.style.color = 'crimson';
        }
    });

    function renderEnv(items){
        const wrap = document.getElementById('envForm');
        if (!wrap) return;

        const sens = items.filter(i => i.sensitive);
        const pub  = items.filter(i => !i.sensitive);

        function rowHtml(i){
            const id   = `env_${i.key}`;
            const warn = i.restart
                ? `<span class="badge warn" style="margin-left:.5rem;">‚ö†Ô∏è √∫jraind√≠t√°s</span>`
                : '';
            const star = i.sensitive ? '‚òÖ ' : '';
            const input = i.sensitive
                ? `<input type="password" id="${id}" data-key="${i.key}" data-sensitive="1" placeholder="${i.value || ''}" />`
                : `<input id="${id}" data-key="${i.key}" value="${(i.value ?? '').replace(/"/g,'&quot;')}" />`;

            return `<div class="row"><div><label>${star}${i.key}${warn}</label>${input}</div></div>`;
        }

        function groupHtml(title, list){
            if (!list.length) return '';
            return `<h3 class="muted" style="margin-top:.75rem;">${title}</h3>` + list.map(rowHtml).join('');
        }

        wrap.innerHTML =
            groupHtml('√ârz√©keny (titkos) kulcsok', sens) +
            groupHtml('√Åltal√°nos kulcsok', pub);
    }

    async function loadEnvAll(){
        const msg = document.getElementById('envMsg'); if (msg) { msg.style.color=''; msg.textContent='Bet√∂lt√©s‚Ä¶'; }
        try{
            const { items } = await api('/admin/config/env');
            renderEnv(items || []);
            if (msg) msg.textContent = 'K√©sz.';
        }catch(e){
            if (msg) { msg.textContent = e.message || 'Hiba a beolvas√°skor'; msg.style.color='crimson'; }
        }
    }

    async function saveEnvAll(){
        const msg = document.getElementById('envMsg');
        const btn = document.getElementById('btnEnvSave'); // ha van k√ºl√∂n ment√©s gombod
        if (msg) { msg.style.color=''; msg.textContent='Ment√©s‚Ä¶'; }
        if (btn) { btn.disabled = true; }

        try{
            const inputs = Array.from(document.querySelectorAll('#envForm [data-key]'));
            const updates = {};

            for (const el of inputs){
                const key = el.getAttribute('data-key');
                const isSecret = el.getAttribute('data-sensitive') === '1';
                const val = (el.value ?? '').trim();

                if (isSecret) {
                    // titkos: csak akkor k√ºldj√ºk, ha t√©nyleg √≠rt be √∫jat
                    if (val !== '') updates[key] = val;
                } else {
                    // publikus: mindig k√ºldj√ºk (ha szeretn√©l diffet, itt tudn√°l √∂sszehasonl√≠tani az eredetivel)
                    updates[key] = val;
                }
            }

            // ha nincs v√°ltoz√°s, ne k√©rj√ºnk ment√©st
            if (Object.keys(updates).length === 0) {
                if (msg) { msg.textContent = 'Nincs m√≥dos√≠t√°s, nincs mit menteni.'; }
                return;
            }

            const res = await api('/admin/config/env', {
                method:'PUT',
                body: JSON.stringify({ updates })
            });

            let txt = (res.message || 'Be√°ll√≠t√°sok friss√≠tve (.env)!');
            if (res.restartNeeded) {
                txt += `  ‚ö†Ô∏è A k√∂vetkez≈ë kulcsok miatt √∫jraind√≠t√°s aj√°nlott: ${res.restartKeys.join(', ')}`;
            }
            if (msg) { msg.style.color=''; msg.textContent = txt; }

            // 1) titkos mez≈ëk √ºr√≠t√©se
            document.querySelectorAll('#envForm [data-sensitive="1"]').forEach(el => {
                const k = el.getAttribute('data-key');
                el.value = '';
                // 2) √∫j maszkolt placeholder, ha a backend visszak√ºldi (pl. res.masked)
                if (res.masked && res.masked[k]) el.placeholder = res.masked[k];
            });

            // 3) ha a backend visszaadja az √∫j list√°t, rendereld √∫jra (k√ºl√∂nben hagyhatod √≠gy is)
            if (res.items) renderEnv(res.items);

        }catch(e){
            if (msg) { msg.textContent = e.message || 'Hiba a ment√©skor'; msg.style.color='crimson'; }
        }finally{
            if (btn) { btn.disabled = false; }
        }
    }

    // gombok
    document.getElementById('btnEnvLoad')?.addEventListener('click', loadEnvAll);
    document.getElementById('btnEnvSave')?.addEventListener('click', saveEnvAll);

    // ha a tabot k√ºl√∂n is el√©rn√©d:
    document.getElementById('navConfig')?.addEventListener('click', () => {
        if (window.__me && window.__me.role === 'owner') loadEnvAll();
    });
</script>
</body>
</html>